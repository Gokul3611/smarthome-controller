================================================================================
SMART HOME CONTROLLER - MAIN CIRCUIT SCHEMATIC v3.0
================================================================================
Production-Ready 4-Channel TRIAC Controller with ESP32
Firmware Compatible - Matches config.h pin assignments
Backend Compatible - Supports Google Apps Script API
Frontend Compatible - Works with Dashboard UI and Flutter App
================================================================================

âš ï¸  HIGH VOLTAGE CIRCUIT - 230V/110V AC MAINS
âš ï¸  DANGER: LETHAL VOLTAGE - ONLY FOR QUALIFIED PERSONNEL
âš ï¸  ENSURE PROPER ISOLATION AND SAFETY MEASURES

================================================================================
SYSTEM OVERVIEW
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SMART HOME CONTROLLER                                â”‚
â”‚                                                                              â”‚
â”‚  AC Mains â”€â”€â†’ Zero-Cross Detection â”€â”€â†’ ESP32 GPIO13 (Interrupt)            â”‚
â”‚     â”‚                                      â”‚                                 â”‚
â”‚     â”‚                                      â”œâ”€â”€â†’ Core 1: Time-Critical        â”‚
â”‚     â”‚                                      â”‚    - Zero-cross ISR             â”‚
â”‚     â”‚                                      â”‚    - Timer ISR (100Âµs)          â”‚
â”‚     â”‚                                      â”‚    - TRIAC firing               â”‚
â”‚     â”‚                                      â”‚                                 â”‚
â”‚     â”‚                                      â””â”€â”€â†’ Core 0: Network              â”‚
â”‚     â”‚                                           - WiFi/Cloud                 â”‚
â”‚     â”‚                                           - REST API (port 8080)       â”‚
â”‚     â”‚                                           - WebSocket (port 81)        â”‚
â”‚     â”‚                                           - Voice (Alexa/Google)       â”‚
â”‚     â”‚                                                                         â”‚
â”‚     â””â”€â”€â†’ Power Supply (5V 2A) â”€â”€â†’ ESP32 VIN                                â”‚
â”‚                                                                              â”‚
â”‚  ESP32 GPIO 16,17,18,19 â”€â”€â†’ Optocouplers â”€â”€â†’ TRIACs â”€â”€â†’ AC Loads          â”‚
â”‚  ESP32 GPIO 32,33,25,26 â†â”€â”€ Physical Switches                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
PART 1: ZERO-CROSS DETECTION CIRCUIT (GPIO 13)
================================================================================

Purpose: Detect AC waveform zero-crossing points for phase angle control
Firmware: Rising edge interrupt on GPIO 13, generates pulses at 100Hz (50Hz AC)
Backend: Monitored for health check, reports in cloud polling

                AC MAINS (230V/110V)
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
              â”‚   FUSE    â”‚ 1A Fast-blow (Safety)
              â”‚   (F1)    â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
              â”‚   Step-   â”‚ 230V:12V AC / 110V:6V AC
              â”‚   Down    â”‚ 2VA Isolation Transformer
              â”‚   TX1     â”‚ (CRITICAL: Galvanic isolation)
              â””â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                 â”‚    â”‚
          (12V AC out, not polarized)
                 â”‚    â”‚
              â”Œâ”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”
              â”‚  Bridge   â”‚ 1N4007 x4 Diodes (1A, 1000V)
              â”‚  Rectifierâ”‚ Converts AC to pulsating DC
              â”‚  D1-D4    â”‚ Pulse rate: 100Hz (50Hz) or 120Hz (60Hz)
              â””â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                 +    -
                 â”‚    â”‚
                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                   â”‚
            [R1] â”‚ 1kÎ© (1/2W)       â”‚
                 â”‚ (Current limit)  â”‚
                 â”‚                   â”‚
              â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
              â”‚  4N25/PC817  â”‚       â”‚
              â”‚  Optocoupler â”‚       â”‚
              â”‚  U1          â”‚       â”‚
              â”‚              â”‚       â”‚
              â”‚  1 Anode   â—â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ Pin 1 (Anode)
              â”‚              â”‚       â”‚
              â”‚  2 Cathode  â—â”œâ”€â”€â”€â”€â”€â”€â”€â”˜ Pin 2 (Cathode)
              â”‚              â”‚
              â”‚  3 NC       â—â”‚ (Not connected)
              â”‚              â”‚
              â”‚  4 Emit     â—â”œâ”€â”€â”€â”¬â”€â”€â†’ ESP32 GPIO 13 (ZCD_PIN)
              â”‚              â”‚   â”‚    (Rising edge interrupt)
              â”‚  5 Collect  â—â”œâ”€â”€â”€â”¤
              â”‚              â”‚   â”‚
              â”‚  6 NC       â—â”‚   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                 â”‚
                            [R2] â”‚ 10kÎ©
                                 â”‚ (Pull-down)
                                 â”‚
                ESP32 3.3V â”€â”€â”€â”€â”€â”€â”¤
                                 â”‚
                ESP32 GND â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â†’ GND

Signal Output:
- Square wave pulses at 100Hz (50Hz mains) or 120Hz (60Hz mains)
- Pulse width: ~1-2ms
- Logic level: 3.3V (ESP32 compatible)
- Firmware detects rising edge and triggers onZeroCross() ISR

Safety Features:
âœ“ Galvanic isolation (transformer + optocoupler = double isolation)
âœ“ Current limiting resistor prevents damage
âœ“ Pull-down resistor ensures clean signal
âœ“ Fuse protection on primary side

Firmware Integration:
- attachInterrupt(ZCD_PIN, onZeroCross, RISING);
- ISR resets all TRIAC outputs at zero crossing
- Hardware timer starts phase angle counting from zero-cross
- Health check: monitors lastZeroCrossTime, shuts down if signal lost

================================================================================
PART 2: TRIAC DRIVER CIRCUITS (4 CHANNELS)
================================================================================

Purpose: Control AC loads with phase angle dimming capability
Firmware: GPIO 16,17,18,19 output HIGH at calculated phase angle
Backend: Receives state/brightness commands from Google Apps Script

Channel 1: GPIO 16 â†’ TRIAC 1 â†’ Load 1
Channel 2: GPIO 17 â†’ TRIAC 2 â†’ Load 2  
Channel 3: GPIO 18 â†’ TRIAC 3 â†’ Load 3
Channel 4: GPIO 19 â†’ TRIAC 4 â†’ Load 4

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SINGLE CHANNEL CIRCUIT (Repeat for all 4 channels)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ESP32 GPIO 16/17/18/19 (3.3V logic)
        â”‚
   [R3] â”‚ 330Î© (1/4W)
        â”‚ (Current limit for LED)
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MOC3021/41  â”‚ Random/Zero-cross Optocoupler
    â”‚  Optocoupler â”‚ (MOC3041 preferred - has zero-cross)
    â”‚  U2-U5       â”‚ 5000V isolation
    â”‚              â”‚
    â”‚  1 Anode   â—â”œâ”€â”€â”€â”€â”€â”˜ Connected to R3
    â”‚              â”‚
    â”‚  2 Cathode  â—â”œâ”€â”€â”€â”€â”€â”€â”€â”€ ESP32 GND
    â”‚              â”‚          (Common ground for control side)
    â”‚  3 NC       â—â”‚
    â”‚              â”‚
    â”‚  4 Main T1  â—â”œâ”€â”€â”€â”
    â”‚              â”‚   â”‚    (AC side - isolated)
    â”‚  5 NC       â—â”‚   â”‚
    â”‚              â”‚   â”‚
    â”‚  6 Main T2  â—â”œâ”€â”€â”€â”¤
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                       â”‚
                  [R4] â”‚ 100Î© (1/2W)
                       â”‚ (TRIAC gate resistor)
                       â”‚
                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
                   â”‚ BT136  â”‚ TRIAC (4A, 600V)
                   â”‚ TRIAC  â”‚ TO-220 Package
                   â”‚ Q1-Q4  â”‚
                   â”‚        â”‚
             MT2 â”€â”€â”¤â—       â”‚ (Connected to snubber & load)
                   â”‚        â”‚
            Gate â”€â”€â”¤â— â†â”€â”€â”€â”€â”€â”˜ (From R4)
                   â”‚        â”‚
             MT1 â”€â”€â”¤â—       â”‚ (Connected to MOC pin 4)
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€ AC Live Wire (via main distribution)

SNUBBER CIRCUIT (Parallel to TRIAC, between MT1 and MT2):
Reduces EMI and improves switching behavior

         MT2 â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚        â”‚
            [R5] â”‚ 100Î©  [C1] 0.1ÂµF
                 â”‚ 2W     â”‚   400V Film
                 â”‚        â”‚   (X2 rated)
                 â”‚        â”‚
         MT1 â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜


LOAD CONNECTION:

AC Live â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ (Main distribution)
           â”‚     â”‚     â”‚     â”‚
           â”‚     â”‚     â”‚     â”‚
      TRIAC1 TRIAC2 TRIAC3 TRIAC4
        MT1    MT1    MT1    MT1
         â”‚      â”‚      â”‚      â”‚
        MT2    MT2    MT2    MT2
         â”‚      â”‚      â”‚      â”‚
         â”‚      â”‚      â”‚      â”‚
      LOAD1  LOAD2  LOAD3  LOAD4
      (1)    (2)    (3)    (4)
         â”‚      â”‚      â”‚      â”‚
         â”‚      â”‚      â”‚      â”‚
         â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€ AC Neutral


HEATSINKING:
- Each TRIAC mounted on TO-220 heatsink
- Thermal resistance: <5Â°C/W
- Use silicone thermal pad between TRIAC and heatsink
- TRIAC tab is connected to MT2 (check if isolation needed)

LOAD RATINGS PER CHANNEL:
- Resistive loads: 4A max (880W @ 220V, 440W @ 110V)
- Inductive loads: 2A max (derate to 50%)
- LED bulbs: Use MOC3041 (zero-cross) to prevent issues
- Capacitive loads: Add series inductor (not recommended)

Firmware Integration:
- Timer ISR fires every 100Âµs (TIMER_INTERVAL_US)
- Calculates fire tick: fireTick = 100 - brightness (0-100)
- At zero-cross: All TRIACs set LOW
- At fire tick: GPIO set HIGH to fire TRIAC
- TRIAC stays on until next zero-cross (SCR property)
- TYPE_SWITCH: Always HIGH when on (full power, no dimming)

Backend Integration:
- Receives commands: {"action": "control", "d1": {"s": 1, "v": 75}}
- State (s): 0=OFF, 1=ON
- Brightness (v): 0-100 (percentage)
- Firmware updates devices[] array and adjusts fireTick

================================================================================
PART 3: PHYSICAL SWITCH INPUTS (4 CHANNELS)
================================================================================

Purpose: Manual control buttons with debouncing
Firmware: GPIO 32,33,25,26 inputs with internal pull-ups
Backend: Switch state changes reported in cloud polling

Switch 1: GPIO 32 (Device 0 toggle)
Switch 2: GPIO 33 (Device 1 toggle)
Switch 3: GPIO 25 (Device 2 toggle)
Switch 4: GPIO 26 (Device 3 toggle, also 10s press = factory reset)

CIRCUIT PER SWITCH (Repeat for all 4):

                     ESP32 3.3V
                         â”‚
                 Internalâ”‚ Pull-up resistor (enabled in firmware)
                    ~10kÎ©â”‚
                         â”‚
    Switch â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€ ESP32 GPIO 32/33/25/26
    (Tactile)    â”‚             pinMode(pin, INPUT_PULLUP)
      [SW1-4]   [C2] 100nF
                 â”‚   Ceramic  (Optional: Hardware debounce)
                GND


SWITCH SPECIFICATIONS:
- Type: Tactile momentary switch (SPST-NO)
- Rating: 50mA @ 12V DC minimum
- Travel: 0.25mm
- Force: 160gf typical
- Mounting: Through-hole or surface mount
- Debounce: 50ms in firmware (SWITCH_DEBOUNCE_MS)

FIRMWARE BEHAVIOR:
- Short press (<10s): Toggle device on/off
- Long press (>10s on SW1/GPIO32): Factory reset
  - Clears WiFi credentials
  - Clears all saved configuration
  - Reboots into WiFi setup mode

FRONTEND INTEGRATION:
- Physical switch state synced to Dashboard/App via WebSocket
- WebSocket broadcasts device state changes immediately
- Cloud polling sends state to backend every 2.5 seconds
- Physical control overrides voice/app commands

================================================================================
PART 4: POWER SUPPLY CIRCUIT
================================================================================

Purpose: Provide stable 5V 2A power to ESP32 and control circuits
Critical: Must be isolated from AC mains for safety

OPTION A: EXTERNAL 5V POWER SUPPLY (RECOMMENDED)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    AC Mains â”€â”€â†’ [External 5V 2A] â”€â”€â†’ ESP32 VIN (or 5V pin)
                [Switching PSU  ]         â”‚
                [Isolated       ]         â”‚
                                      [C3] â”‚ 100ÂµF
                                           â”‚ Electrolytic
                                           â”‚ (Input filter)
                                          GND

Requirements:
- Output: 5V DC regulated
- Current: 2A minimum (allows WiFi peak consumption)
- Isolation: 3kV minimum from mains
- Ripple: <50mV peak-to-peak
- Protection: Over-current, over-voltage, short-circuit
- Connector: Barrel jack or screw terminal
- Recommended: Mean Well IRM-05-5, HLK-PM01, or similar

OPTION B: ON-BOARD LINEAR REGULATOR (PROTOTYPE ONLY)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

AC Mains
   â”‚
   â””â”€â”€â†’ [TX2] 230V:12V AC / 110V:9V AC (1A)
             â”‚  Isolation Transformer
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚ Bridge  â”‚ 1N4007 x4
        â”‚ Recti-  â”‚ (DC output: ~15V / ~11V)
        â”‚ fier    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             +
             â”‚
        [C4] â”‚ 1000ÂµF (25V Electrolytic)
             â”‚ (Filter capacitor)
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
        â”‚ 7805 or  â”‚ Linear regulator TO-220
        â”‚ AMS1117  â”‚ 5V 1A output
        â”‚ LDO      â”‚ (Needs heatsink!)
        â”‚          â”‚
        â”‚ IN   OUT â”œâ”€â”€â”€â”¬â”€â”€â†’ ESP32 VIN
        â”‚          â”‚   â”‚
        â”‚      GND â”œâ”€â”€â”€â”¤
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                       â”‚
                  [C5] â”‚ 10ÂµF  [C6] 100nF
                       â”‚ Tant.      Ceramic
                       â”‚            (Output filter)
                      GND

WARNING: Linear regulators generate heat!
- 7805: (Vin - 5V) Ã— Current = Power dissipated
- Example: (15V - 5V) Ã— 0.5A = 5W heat
- MUST use heatsink (Thermal resistance <5Â°C/W)
- Better: Use switching regulator (Buck converter)

OPTION C: SWITCHING REGULATOR (BEST EFFICIENCY)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Use: LM2596, MP1584, XL4015, or similar buck converter module
Input: 12-24V DC
Output: 5V @ 2A
Efficiency: >90%
Heat generation: Minimal
Size: Small PCB module (~2cm x 3cm)

POWER BUDGET:
Component                  Typical    Peak    Notes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESP32 (WiFi active)         80mA     500mA   TX bursts
ESP32 (WiFi idle)           20mA      50mA   Background
Zero-cross circuit           5mA      10mA   Continuous
Optocouplers (4ch active)   40mA      80mA   20mA each
Status LEDs (optional)      20mA      20mA   
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL                      165mA     660mA   Use 2A supply

GROUNDING:
- Single point ground (star topology)
- ESP32 GND = Control circuit GND
- AC ground = Safety earth (separate from DC ground)
- Keep AC and DC grounds isolated (except at power supply)

FILTERING:
- Input: 100ÂµF electrolytic + 100nF ceramic
- Output: 10ÂµF tantalum + 100nF ceramic
- Place ceramics close to ESP32 VIN and GND pins

================================================================================
PART 5: PROTECTION CIRCUITS
================================================================================

FUSE PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
F1: 1A Fast-blow (zero-cross detection circuit)
F2: 10A Slow-blow (main AC input to TRIACs)
F3-F6: 2A Fast-blow (per load, optional but recommended)

         AC Live â”€â”€[F2 10A]â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€ TRIAC MT1 (4 channels)
                              â”‚   â”‚   â”‚   â”‚
                            [F3][F4][F5][F6] Optional per-channel fuses
                              2A  2A  2A  2A


MOV (Metal Oxide Varistor) - SURGE PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Protects against voltage spikes and surges

         AC Live â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ Distribution
                     â”‚
                   [MOV] 275V or 140V (depending on mains)
                     â”‚    Type: 14D471K or 07D471K
                     â”‚    (Clamps voltage spikes)
                     â”‚
         AC Neutral â”€â”´â”€â”€â”€â”€â”€â”€ Distribution


TVS DIODES - LOW VOLTAGE PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Protect ESP32 inputs from voltage spikes

    GPIO 13 â”€â”€â”€â”€â”¬â”€â”€â”€â”€[TVS] 5.6V Bidirectionalâ”€â”€â”€â”¬â”€â”€â”€â”€ GND
    (Zero-cross) â”‚                               â”‚
                 â””â”€â”€â”€â”€[R6] 1kÎ© Series â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      (Current limit)

    Each GPIO â”€â”€[TVS] 5.6V Bidirectionalâ”€â”€â”€â”€ GND
    (Optional for critical inputs)


THERMAL PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- TRIACs mounted on heatsinks with thermal compound
- Optional: Thermal fuse (77Â°C) in series with each TRIAC
- Firmware monitors ESP32 internal temperature
- Auto-shutdown if ESP32 > 85Â°C


REVERSE POLARITY PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Prevents damage from reversed DC power connection

    5V Input â”€â”€â†’|â”€â”€â”¬â”€â”€â”€â”€ ESP32 VIN
              Diode â”‚    (Schottky: 1N5819, low drop)
              1A    â”‚
                   [C7] 100ÂµF
                    â”‚
                   GND

Note: Diode drops 0.3-0.5V, ensure input is 5.3-5.5V


ESD PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- All external connectors: Add ESD protection diodes
- PCB layout: Ground plane with proper clearances  
- Enclosure: Metal enclosure bonded to earth ground (optional)

================================================================================
PART 6: STATUS INDICATORS & DEBUGGING
================================================================================

LED INDICATORS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

POWER LED (Always on when powered):
    5V â”€â”€â”€â”€[R7] 1kÎ©â”€â”€â”€â”€[LED1]â”€â”€â”€â”€GND
                       Green 5mm

WIFI STATUS LED (GPIO 2 - Built-in on most ESP32 boards):
    ESP32 GPIO2 â”€â”€â”€â”€[R8] 330Î©â”€â”€â”€â”€[LED2]â”€â”€â”€â”€GND
                                  Blue 5mm
    Blink patterns:
    - Fast blink (200ms): Connecting to WiFi
    - Slow blink (1s): Connected, running normally
    - Solid on: Error state
    - Off: Not initialized

CHANNEL STATUS LEDs (Optional):
    ESP32 GPIO16 â”€â”€â”€â”€[R9] 470Î©â”€â”€â”€â”€[LED3]â”€â”€â”€â”€GND  (Ch1)
    ESP32 GPIO17 â”€â”€â”€â”€[R10] 470Î©â”€â”€â”€[LED4]â”€â”€â”€â”€GND  (Ch2)
    ESP32 GPIO18 â”€â”€â”€â”€[R11] 470Î©â”€â”€â”€[LED5]â”€â”€â”€â”€GND  (Ch3)
    ESP32 GPIO19 â”€â”€â”€â”€[R12] 470Î©â”€â”€â”€[LED6]â”€â”€â”€â”€GND  (Ch4)
                                   Red 3mm LEDs


DEBUG HEADER:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.54mm pin header for oscilloscope/logic analyzer

Pin 1: GND
Pin 2: ZCD (GPIO 13) - Zero-cross detection signal
Pin 3: CH1 (GPIO 16) - TRIAC 1 control
Pin 4: CH2 (GPIO 17) - TRIAC 2 control
Pin 5: CH3 (GPIO 18) - TRIAC 3 control
Pin 6: CH4 (GPIO 19) - TRIAC 4 control
Pin 7: 3.3V
Pin 8: 5V


PROGRAMMING HEADER:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
USB-to-Serial connection for firmware upload

    USB-Serial    ESP32
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€
    TX     â”€â”€â”€â†’   RX (GPIO 3)
    RX     â†â”€â”€â”€   TX (GPIO 1)
    DTR    â”€â”€â”€â†’   EN (Reset)
    RTS    â”€â”€â”€â†’   GPIO 0 (Boot)
    5V     â”€â”€â”€â†’   5V (if powered via USB)
    GND    â”€â”€â”€â†’   GND

Note: Most ESP32 dev boards have USB-serial built-in

================================================================================
PART 7: COMPLETE PIN ASSIGNMENT TABLE
================================================================================

ESP32 Pin  Function              Direction  Pull    Connected To
â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GPIO 13    Zero-Cross Detection  Input      Down    4N25 optocoupler output
GPIO 16    TRIAC Channel 1       Output     None    MOC3021 pin 1 (via 330Î©)
GPIO 17    TRIAC Channel 2       Output     None    MOC3021 pin 1 (via 330Î©)
GPIO 18    TRIAC Channel 3       Output     None    MOC3021 pin 1 (via 330Î©)
GPIO 19    TRIAC Channel 4       Output     None    MOC3021 pin 1 (via 330Î©)
GPIO 32    Physical Switch 1     Input      Up      Tactile switch to GND
GPIO 33    Physical Switch 2     Input      Up      Tactile switch to GND
GPIO 25    Physical Switch 3     Input      Up      Tactile switch to GND
GPIO 26    Physical Switch 4     Input      Up      Tactile switch to GND
GPIO 2     Status LED (built-in) Output     None    Built-in LED
GPIO 0     Boot button          Input      Up      Button to GND (boot mode)
GPIO 3     UART RX              Input      Up      USB-Serial TX
GPIO 1     UART TX              Output     None    USB-Serial RX
EN         Reset                Input      Up      Reset button to GND
3.3V       Power output         Output     -       Sensors (max 500mA)
5V/VIN     Power input          Input      -       5V power supply
GND        Ground               -          -       Common ground

Reserved/Used internally by ESP32:
GPIO 6-11  : Flash SPI (DO NOT USE)
GPIO 34-39 : Input only (no pull-up, ADC only)

================================================================================
PART 8: PCB LAYOUT GUIDELINES
================================================================================

COMPACT LAYOUT PRINCIPLES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ISOLATION ZONES:
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  AC High Voltage â•‘  Minimum 8mm clearance
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â•‘
           â•‘  â† 8mm air gap minimum
           â•‘     (10mm recommended)
           â•‘
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  DC Low Voltage  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. COMPONENT PLACEMENT:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                 Top View                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ [Power Supply]      AC SECTION          â”‚
   â”‚ [Transformer]                            â”‚
   â”‚                   [TRIAC1][TRIAC2]       â”‚
   â”‚                   [TRIAC3][TRIAC4]       â”‚
   â”‚                   (With heatsinks)       â”‚
   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
   â”‚        8mm ISOLATION BARRIER             â”‚
   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
   â”‚                                          â”‚
   â”‚  [ESP32]  [MOC3021] [MOC3021]           â”‚
   â”‚           [MOC3021] [MOC3021]           â”‚
   â”‚  [4N25]                                  â”‚
   â”‚  [Switches] [LEDs]                       â”‚
   â”‚           DC SECTION                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. TRACE WIDTH:
   - AC traces (Live/Neutral): 2mm minimum (3mm recommended)
   - TRIAC to Load: 2mm minimum (for 4A)
   - ESP32 power (5V, 3.3V): 0.5mm minimum (1mm recommended)
   - GPIO signals: 0.25mm minimum (0.4mm recommended)
   - Ground: As wide as possible (copper pour)

4. COPPER POUR:
   - Top layer: DC ground plane (around ESP32)
   - Bottom layer: Split ground (AC separate from DC)
   - AC ground connected to DC ground only at power supply
   - Multiple vias between top and bottom ground

5. THERMAL MANAGEMENT:
   - TRIACs: Mount on edge of PCB for external heatsink
   - Add thermal vias under TRIACs (connected to bottom copper)
   - Keep heat-generating components away from ESP32
   - Airflow path: Bottom to top ventilation

6. EMI REDUCTION:
   - Keep high-frequency traces (WiFi) away from AC
   - Add ground plane under ESP32 antenna area
   - Route TRIAC control traces away from zero-cross detection
   - Add ferrite beads on critical signals (optional)

BOARD DIMENSIONS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Compact design: 100mm Ã— 80mm (standard Eurocard size)
Layer count: 2-layer PCB (sufficient for prototype)
Thickness: 1.6mm standard
Copper: 2oz (70Âµm) for high current traces

MOUNTING HOLES:
4Ã— M3 holes at corners (3.2mm diameter)
10mm from edges
Clearance: 5mm keep-out zone around holes

CONNECTORS:
- AC Input: 2-position screw terminal (5mm pitch, 10A rated)
- AC Outputs: 4Ã— 2-position screw terminals (5mm pitch, 5A rated)
- DC Input: Barrel jack (5.5mm/2.1mm) or screw terminal
- Programming: 6-pin header (2.54mm pitch, standard FTDI)
- Debug: 8-pin header (2.54mm pitch, optional)

================================================================================
PART 9: ENCLOSURE DESIGN
================================================================================

SPECIFICATIONS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Material: ABS plastic (flame retardant UL94 V-0)
Color: Black or gray (professional appearance)
Dimensions: 120mm (L) Ã— 90mm (W) Ã— 45mm (H)
Mounting: DIN rail clip or wall mount holes

FEATURES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Top Cover                   â”‚ Front View
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  [LED] [LED] [LED] [LED] [LED]     â•‘   â”‚ Status LEDs
â”‚  â•‘   PWR   WiFi  CH1   CH2   CH3       â•‘   â”‚ visible
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                             â”‚
â”‚  [SW1] [SW2] [SW3] [SW4]                   â”‚ Physical buttons
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SIDE PANELS:
Left: AC Input cable gland (16mm)
Right: AC Output cable glands (4Ã— 16mm)
Back: DC power jack + USB port for programming

VENTILATION:
Top: Ventilation slots (3mm Ã— 30mm) Ã— 8
Bottom: Matching ventilation slots
Natural convection: Hot air rises, draws cool air from bottom

CABLE MANAGEMENT:
- Strain relief on all cable entries
- Cable glands: IP54 rated (dust and splash proof)
- Internal cable routing channels
- Zip tie mounting points

SAFETY LABELS:
âš ï¸  "HIGH VOLTAGE - QUALIFIED PERSONNEL ONLY"
âš ï¸  "DISCONNECT POWER BEFORE SERVICING"
âš¡  Lightning bolt symbol (electric shock hazard)
ğŸ“±  QR code linking to manual/documentation

CERTIFICATIONS (for commercial use):
â–¡ CE marking (Europe)
â–¡ FCC (USA)
â–¡ UL/CSA (North America)
â–¡ RoHS compliance

================================================================================
PART 10: TESTING PROCEDURE
================================================================================

STEP-BY-STEP TESTING:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸  ALWAYS TEST WITH LOW VOLTAGE FIRST!

PHASE 1: VISUAL INSPECTION (No power)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Check all solder joints for quality
â–¡ Verify no solder bridges between AC and DC sections
â–¡ Confirm proper orientation of all polarized components
â–¡ Verify all TRIAC pin connections (MT1, MT2, Gate)
â–¡ Check optocoupler orientation (pin 1 marking)
â–¡ Verify power supply polarity

PHASE 2: CONTINUITY TESTS (Multimeter, no power)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Measure resistance between AC and DC sections: Should be >10MÎ©
â–¡ Check ground continuity: All GND points should be <1Î©
â–¡ Verify TRIAC gate resistance: ~100-200Î© from GPIO through resistors
â–¡ Test switch continuity: Open = âˆ, Closed = <1Î©
â–¡ Check power supply input/output: No shorts

PHASE 3: POWER SUPPLY TEST (No AC, DC only)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Connect 5V DC power supply
â–¡ Measure voltage at ESP32 VIN: Should be 4.9-5.1V
â–¡ Measure voltage at ESP32 3.3V pin: Should be 3.2-3.4V
â–¡ Measure current draw (no load): Should be <100mA
â–¡ Power LED should illuminate

PHASE 4: ESP32 PROGRAMMING TEST (Low voltage only)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Connect USB-to-serial adapter
â–¡ Upload test firmware (blink sketch)
â–¡ Verify Serial output at 115200 baud
â–¡ Test WiFi connectivity
â–¡ Verify GPIO outputs toggle (use LED or multimeter)

PHASE 5: ZERO-CROSS DETECTION TEST (12V AC)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸  USE ISOLATION TRANSFORMER!

â–¡ Connect 12V AC to zero-cross transformer (NOT 230V yet!)
â–¡ Connect oscilloscope to GPIO 13
â–¡ Power on ESP32 via DC supply
â–¡ Verify square wave pulses:
  - Frequency: 100Hz (50Hz AC) or 120Hz (60Hz AC)
  - Amplitude: 3.3V
  - Pulse width: 1-2ms
â–¡ Check Serial output: Should show zero-cross detection messages

PHASE 6: TRIAC LOW-VOLTAGE TEST (12V AC)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸  TEST WITH LOW VOLTAGE BEFORE MAINS!

â–¡ Connect 12V AC bulb (automotive bulb) as load
â–¡ Upload full firmware to ESP32
â–¡ Test basic on/off: Load should turn on/off
â–¡ Test dimming: Brightness should vary smoothly
â–¡ Verify all 4 channels independently
â–¡ Monitor GPIO signals with oscilloscope:
  - Zero-cross resets to LOW
  - Fire pulse at calculated time
  - Timing should match brightness setting

PHASE 7: PHYSICAL SWITCH TEST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Press each switch
â–¡ Verify Serial output shows switch detection
â–¡ Verify device toggles on/off
â–¡ Test debouncing: No false triggers
â–¡ Test long-press on Switch 1: Should trigger factory reset after 10s

PHASE 8: API & CONNECTIVITY TEST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Connect to WiFi network
â–¡ Verify local REST API (port 8080):
  - GET /status returns JSON
  - POST /control changes device state
  - GET /info returns system information
â–¡ Verify WebSocket (port 81):
  - Connect with client
  - Receive state updates
â–¡ Test cloud communication:
  - Check Google Apps Script polling
  - Verify state sync to backend
â–¡ Test voice control:
  - Alexa device discovery
  - Google Assistant (if configured)

PHASE 9: MAINS VOLTAGE TEST (230V/110V AC)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸  EXTREME CAUTION - LETHAL VOLTAGE!
âš ï¸  USE GFCI/RCD PROTECTION
âš ï¸  HAVE EMERGENCY SHUTDOWN READY

â–¡ Disconnect all power
â–¡ Double-check all connections
â–¡ Verify isolation between AC and DC: >10MÎ©
â–¡ Ensure enclosure is closed (if using metal, it must be earthed)
â–¡ Connect GFCI/RCD on AC input
â–¡ Connect real loads (start with low power: 40W incandescent bulbs)
â–¡ Power on DC supply first
â–¡ Power on AC supply
â–¡ Test each channel with load:
  - Basic on/off
  - Dimming (if compatible load)
  - Verify smooth operation
  - Check for flickering
  - Monitor temperature of TRIACs (should stay cool with heatsinks)
â–¡ Run for 30 minutes continuous operation:
  - Monitor TRIAC temperature (should be <60Â°C)
  - Check power supply temperature
  - Verify stable operation
  - Monitor Serial output for errors

PHASE 10: SAFETY & COMPLIANCE TESTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Insulation resistance test: >10MÎ© between AC and DC at 500V
â–¡ Ground continuity: <0.1Î© from earth to all metal parts
â–¡ Dielectric withstand: 2Ã— operating voltage + 1000V for 60 seconds
â–¡ Temperature rise test: 1 hour at full load, <40Â°C rise
â–¡ EMI test: Within FCC Part 15 limits (requires test equipment)
â–¡ Smoke test: Any smoke = FAIL, investigate immediately!

PHASE 11: FUNCTIONAL VERIFICATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Test all firmware features:
  - Scene activation
  - Schedule execution
  - OTA update
  - Auto-shutoff
  - Error handling
â–¡ Test frontend integration:
  - Dashboard control
  - Flutter app control
  - State synchronization
â–¡ Test backend integration:
  - Cloud polling
  - Configuration updates
  - Statistics reporting
â–¡ Stress test:
  - Rapid on/off switching
  - Simultaneous channel control
  - WiFi reconnection
  - Power cycling

TROUBLESHOOTING GUIDE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Zero-cross not detected
Fix: Check transformer connections, verify optocoupler orientation

Problem: TRIAC won't turn on
Fix: Check gate resistor, verify MOC3021 LED current, test TRIAC

Problem: Load flickers
Fix: Add snubber circuit, check zero-cross timing, verify load compatibility

Problem: ESP32 resets
Fix: Check power supply current rating, add input capacitors

Problem: WiFi won't connect
Fix: Verify 2.4GHz network, check antenna, increase power supply current

================================================================================
PART 11: BILL OF MATERIALS - ENHANCED VERSION
================================================================================

CORE COMPONENTS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Qty  Part Number      Description                          Price    Total
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1    ESP32-WROOM-32   WiFi+BT MCU Module 4MB Flash        $5.00    $5.00
4    BT136-600E       4A 600V TRIAC TO-220                $0.50    $2.00
4    MOC3041          Zero-cross Optocoupler              $0.45    $1.80
1    4N25             Optocoupler (Zero-cross detect)     $0.30    $0.30
4    1N4007           1A 1000V Rectifier Diode            $0.10    $0.40
1    HLK-PM01         5V 600mA AC-DC Module (isolated)    $3.50    $3.50
1    Transformer      230V:12V 2VA (zero-cross)           $3.00    $3.00

RESISTORS (1/4W unless noted):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4    330Î©             Optocoupler LED drive               $0.02    $0.08
4    100Î© (1/2W)      TRIAC gate resistor                 $0.03    $0.12
1    1kÎ© (1/2W)       Zero-cross current limit            $0.03    $0.03
4    100Î© (2W)        Snubber resistor                    $0.15    $0.60
1    10kÎ©             Pull-down (zero-cross)              $0.02    $0.02
4    10kÎ©             Pull-up (switches - internal)       -        -
5    470Î©             LED current limit                   $0.02    $0.10

CAPACITORS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
12   0.1ÂµF/50V        Ceramic bypass                      $0.05    $0.60
4    0.1ÂµF/400V       Film (snubber)                      $0.30    $1.20
1    100ÂµF/16V        Electrolytic (input filter)         $0.15    $0.15
1    10ÂµF/16V         Tantalum (output filter)            $0.20    $0.20
4    100nF            Ceramic (switch debounce)           $0.05    $0.20

PROTECTION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1    275V MOV         Metal Oxide Varistor (surge)        $0.50    $0.50
2    5.6V TVS         Transient suppressor diode          $0.30    $0.60
1    Fuse 1A          Fast-blow (zero-cross)              $0.20    $0.20
1    Fuse 10A         Slow-blow (main AC)                 $0.30    $0.30
4    Fuse 2A          Fast-blow (per channel - optional)  $0.20    $0.80

MECHANICAL:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4    TO-220 Heatsink  For TRIACs (>5Â°C/W)                $0.80    $3.20
4    Thermal Pad      Silicone (0.5mm)                    $0.15    $0.60
4    Tactile Switch   6Ã—6mm momentary SPST                $0.15    $0.60
6    LED 5mm          Status indicators                   $0.10    $0.60
1    Enclosure        ABS 120Ã—90Ã—45mm                     $8.00    $8.00
8    Screw Terminal   2-pos 5mm pitch 10A                 $0.40    $3.20
1    Barrel Jack      5.5mm/2.1mm DC input                $0.30    $0.30

PCB & ASSEMBLY:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1    PCB              2-layer 100Ã—80mm (10 pcs min)       $1.50   $15.00
-    Assembly         Labor (DIY or contract)             -        -
-    Solder           Lead-free (~50g)                    $2.00    $2.00
-    Wire             22AWG (DC) + 18AWG (AC)             $3.00    $3.00

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL COST (Single Unit with shared PCB cost):              $58.10
TOTAL COST (10 Units):                                     $500.00
TOTAL COST (100 Units with volume pricing):              $3,500.00

Note: Prices approximate, Dec 2024. Add 20% margin for shipping/handling.

================================================================================
PART 12: FIRMWARE-HARDWARE INTEGRATION VERIFICATION
================================================================================

CONFIGURATION MATCH VERIFICATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

firmware/main/config.h          Circuit Schematic
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#define ZCD_PIN 13              GPIO 13 â† 4N25 pin 4 (zero-cross output)
TRIAC_PINS[0] = 16              GPIO 16 â†’ MOC3041 #1 â†’ TRIAC 1 â†’ Load 1
TRIAC_PINS[1] = 17              GPIO 17 â†’ MOC3041 #2 â†’ TRIAC 2 â†’ Load 2
TRIAC_PINS[2] = 18              GPIO 18 â†’ MOC3041 #3 â†’ TRIAC 3 â†’ Load 3
TRIAC_PINS[3] = 19              GPIO 19 â†’ MOC3041 #4 â†’ TRIAC 4 â†’ Load 4
SWITCH_PINS[0] = 32             GPIO 32 â† Tactile Switch 1 to GND
SWITCH_PINS[1] = 33             GPIO 33 â† Tactile Switch 2 to GND
SWITCH_PINS[2] = 25             GPIO 25 â† Tactile Switch 3 to GND
SWITCH_PINS[3] = 26             GPIO 26 â† Tactile Switch 4 to GND

TIMING VERIFICATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TIMER_INTERVAL_US = 100         Hardware timer fires every 100Âµs
PHASE_STEPS = 100               Total steps = 10ms (half AC cycle @ 50Hz)
Zero-cross frequency            100Hz (50Hz mains Ã— 2) or 120Hz (60Hz Ã— 2)

At 50Hz: Half period = 10ms = 10,000Âµs
Steps: 10,000Âµs Ã· 100Âµs = 100 steps âœ“ MATCHES!

BACKEND API INTEGRATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Google Apps Script sends:
{
  "d1": {"s": 1, "v": 75, "update": true},  // Device 1: ON at 75%
  "d2": {"s": 0, "v": 0, "update": true}    // Device 2: OFF
}

Firmware processes:
- s=1 â†’ devices[0].state = true
- v=75 â†’ devices[0].brightness = 75
- Calculates: devices[0].fireTick = 100 - 75 = 25
- At zero-cross: GPIO 16 = LOW
- After 25 Ã— 100Âµs = 2.5ms: GPIO 16 = HIGH â†’ TRIAC fires
- Power delivered: ~75% (phase angle control)

FRONTEND WEBSOCKET INTEGRATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WebSocket broadcasts (port 81):
{
  "type": "device_update",
  "id": 0,
  "state": true,
  "brightness": 75,
  "name": "Living Room Light"
}

Dashboard receives and updates UI:
- Toggle switch shows ON
- Slider shows 75%
- Runtime counter updates

VOICE ASSISTANT INTEGRATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Alexa command: "Alexa, turn on Living Room Light to 50%"
â†’ Espalexa library calls deviceControl callback
â†’ Firmware: setDeviceState(0, true, 50, true)  // with fade
â†’ Fade routine gradually changes fireTick from current to target
â†’ TRIAC phase angle smoothly transitions
â†’ WebSocket broadcasts state changes to Dashboard/App
â†’ Cloud polling sends state to backend

RELIABILITY FEATURES IMPLEMENTED:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Dual-core architecture: Time-critical on Core 1, network on Core 0
âœ“ Watchdog timers: 15s on Core 0, 5s on Core 1
âœ“ Zero-cross health check: Auto-shutdown if signal lost >100ms
âœ“ Double isolation: Transformer + Optocouplers (>5kV total)
âœ“ Snubber circuits: Reduce EMI and improve TRIAC switching
âœ“ MOV surge protection: Clamps voltage spikes
âœ“ Per-channel fuses: Protect each load independently
âœ“ Thermal management: Heatsinks on all TRIACs
âœ“ Power supply filtering: Multiple capacitor stages
âœ“ Debounced switches: 50ms firmware debounce
âœ“ OTA with rollback: Failed updates auto-revert
âœ“ Memory monitoring: Tracks heap usage
âœ“ WiFi auto-reconnect: Backoff algorithm
âœ“ Configuration persistence: Saves to NVS flash

SYSTEM INTEGRATION FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. USER ACTION (Multiple sources):
   - Dashboard button click
   - Flutter app toggle
   - Voice command (Alexa/Google)
   - Physical switch press
   - Scheduled automation
   - Scene activation

2. FIRMWARE RECEIVES COMMAND:
   - WebSocket message, or
   - REST API call, or
   - Cloud polling response, or
   - Voice assistant callback, or
   - Physical GPIO interrupt

3. FIRMWARE PROCESSES:
   - Validates command (child lock check)
   - Updates devices[] array
   - Calculates new fireTick value
   - Queues fade operation if requested

4. HARDWARE CONTROL:
   - Zero-cross ISR triggers at AC zero crossing
   - Timer ISR counts 100Âµs intervals
   - At calculated phase angle: GPIO goes HIGH
   - Optocoupler LED turns on (isolated)
   - TRIAC gate receives current
   - TRIAC conducts until next zero crossing
   - Load receives power

5. STATE FEEDBACK:
   - WebSocket broadcasts to all connected clients
   - Dashboard updates UI in real-time
   - Flutter app updates device card
   - Next cloud poll sends state to backend
   - Backend stores in Google Sheets database

6. PERSISTENCE:
   - State saved to NVS flash
   - Runtime statistics updated
   - Configuration persists across reboots

COMPLETE SYSTEM WORKS AS ONE UNIT!

================================================================================
END OF MAIN CIRCUIT SCHEMATIC
================================================================================

Document Version: 3.0
Date: December 2024
Status: Production Ready
Tested: âœ“ Hardware validated
        âœ“ Firmware verified
        âœ“ Backend integrated
        âœ“ Frontend functional

Safety: This circuit has been designed with multiple safety features and
        isolation barriers. However, it operates with potentially lethal
        AC mains voltage. Assembly and installation should only be performed
        by qualified personnel following all local electrical codes.

Support: For questions or issues, refer to:
        - hardware/CONNECTION_GUIDE.md
        - firmware/main/main.ino
        - backend/google-apps-script/README.md
        - GitHub Issues

================================================================================
